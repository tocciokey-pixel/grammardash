<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0a0f1e">
  <title>NextStage</title>

  <style>
    :root {
      --bg: #0a0f1e;
      --card: #161e31;
      --accent: #22d3ee;
      --danger: #f43f5e;
      --success: #10b981;
      --text: #ffffff;
      --text-dim: #64748b;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
    body {
      background-color: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Kaku Gothic ProN", sans-serif;
      overflow-x: hidden;
      -webkit-user-select: none;
    }
    .container { max-width: 500px; margin: 0 auto; min-height: 100vh; padding: 20px; display: flex; flex-direction: column; padding-bottom: 50px; }
    header { padding: 40px 0 20px; }
    h1 { font-size: 32px; font-weight: 900; font-style: italic; background: linear-gradient(90deg, #22d3ee, #818cf8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -1px; }

    .xp-container { background: #1e293b; height: 10px; border-radius: 5px; margin-top: 15px; overflow: hidden; }
    .xp-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
    .stats-text { display: flex; justify-content: space-between; font-size: 11px; font-weight: 900; color: var(--text-dim); margin-top: 6px; letter-spacing: 1px; }

    .btn-start {
      background: linear-gradient(135deg, #22d3ee, #3b82f6);
      border: none; border-radius: 28px; padding: 28px; color: #0a0f1e;
      font-size: 20px; font-weight: 900; width: 100%; margin: 18px 0 12px;
      box-shadow: 0 12px 30px rgba(34, 211, 238, 0.3); transition: transform 0.1s;
    }
    .btn-start:active { transform: scale(0.96); }

    .btn-secondary {
      background: var(--card); border: 1px solid #2d3748; padding: 18px;
      border-radius: 20px; color: white; font-weight: bold; font-size: 14px;
      width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px;
      margin-bottom: 12px;
    }

    .section-title { font-size: 11px; font-weight: 900; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1.5px; margin: 18px 0 12px; }
    .cat-card {
      background: var(--card); border-radius: 22px; padding: 20px; margin-bottom: 12px;
      display: flex; align-items: center; justify-content: space-between;
      border: 1px solid rgba(255,255,255,0.03);
    }
    .cat-name { font-size: 16px; font-weight: 800; margin-bottom: 4px; }
    .cat-meta { font-size: 11px; font-weight: bold; color: var(--accent); display: flex; align-items: center; gap: 6px; }
    .tag-current {
      font-size: 10px; font-weight: 900; padding: 6px 10px; border-radius: 999px;
      background: rgba(34,211,238,0.12); color: var(--accent); border: 1px solid rgba(34,211,238,0.2);
      letter-spacing: 1px;
    }

    #quiz-screen, #history-screen, #bookmarks-screen {
  ã€€ã€€position: fixed; inset: 0; background: var(--bg); z-index: 1000;
ã€€ã€€  display: none; flex-direction: column; padding: 20px; padding-top: 60px;
ã€€ã€€}

    #timer-track { width: 100%; height: 6px; background: #1e293b; border-radius: 3px; margin: 20px 0; overflow: hidden; }
    #timer-bar { height: 100%; background: var(--accent); width: 100%; transition: width 0.1s linear; }

    .q-text { font-size: 24px; font-weight: 800; line-height: 1.4; margin-bottom: 40px; }
    .option {
      background: var(--card); border: 2px solid #2d3748; padding: 20px;
      border-radius: 18px; color: white; text-align: left; font-size: 17px; font-weight: 600;
      margin-bottom: 12px; width: 100%;
    }
    .option.correct { border-color: var(--success); background: rgba(16,185,129,0.15); color: var(--success); }
    .option.wrong { border-color: var(--danger); background: rgba(244,63,89,0.15); color: var(--danger); }

    #success-msg {
      position: fixed; inset: 0; z-index: 2000; display: none;
      align-items: center; justify-content: center; background: rgba(10,15,30,0.7);
    }
    .pop {
      background: var(--accent); color: #0a0f1e; padding: 40px; border-radius: 50%;
      width: 200px; height: 200px; display: flex; flex-direction: column; align-items: center;
      justify-content: center; font-weight: 900; font-size: 26px;
      animation: slowPop 2.0s ease-in-out forwards;
    }
    @keyframes slowPop {
      0% { transform: scale(0.2); opacity: 0; }
      15% { transform: scale(1.1); opacity: 1; }
      85% { transform: scale(1); opacity: 1; }
      100% { transform: scale(1.2); opacity: 0; }
    }

    #loading-overlay {
      position: fixed; inset: 0; background: rgba(10,15,30,0.95); z-index: 5000;
      display: none; flex-direction: column; align-items: center; justify-content: center;
      text-align: center; padding: 20px;
    }
    .spinner { width: 40px; height: 40px; border: 4px solid var(--accent); border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 20px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .small { font-size: 11px; font-weight: 900; color: var(--text-dim); letter-spacing: 1px; }
    .card {
      background: var(--card); border: 1px solid rgba(255,255,255,0.06);
      border-radius: 18px; padding: 16px; margin-bottom: 12px;
    }
    .row { display:flex; justify-content:space-between; gap:12px; align-items:baseline; }
    .pill { font-size: 11px; font-weight: 900; padding: 6px 10px; border-radius: 999px; background: #1e293b; color: #cbd5e1; }
    .danger { color: var(--danger); }
    .success { color: var(--success); }
  </style>
</head>

<body>
  <div id="loading-overlay">
    <div class="spinner"></div>
    <div style="font-weight:900;">ANALYZING...</div>
    <div id="loading-sub" style="font-size:11px; color:var(--text-dim); margin-top:10px;">è¤‡æ•°æšã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å•é¡Œã‚’ç”Ÿæˆä¸­</div>
  </div>

  <div id="success-msg"><div class="pop">EXCELLENT!</div></div>

  <div class="container" id="home">
    <header>
      <h1>NextStage</h1>
      <div class="xp-container"><div id="xp-bar" class="xp-fill"></div></div>
      <div class="stats-text">
        <span id="lv-text">LEVEL 1</span>
        <span id="xp-val">0 / 1000 XP</span>
      </div>
    </header>

    <button class="btn-start" onclick="startSession()">
      START (UP TO 10)
    </button>

    <button class="btn-secondary" onclick="openHistory()">
      <span>ğŸ“ˆ STUDY HISTORY</span>
    </button>

    <button class="btn-secondary" onclick="exportData()">
      <span>ğŸ’¾ BACKUP DATA</span>
    </button>

    <button class="btn-secondary" onclick="document.getElementById('import').click()">
      <span>ğŸ“¥ RESTORE DATA</span>
      <input type="file" id="import" accept="application/json" style="display:none" onchange="importData(this)">
    </button>

    <button class="btn-secondary" onclick="document.getElementById('input').click()">
      <span>ğŸ“¸ ADD PHOTOS / PDF</span>
      <input type="file" id="input" multiple accept="image/*,application/pdf" style="display:none" onchange="handleScan(this)">
    </button>

    <button class="btn-secondary" onclick="openBookmarks()">
  ã€€ã€€<span>ğŸ“Œ BOOKMARKS</span>
ã€€ã€€</button>

    
    <div class="section-title">Weakness Areas</div>
    <div id="cat-list"></div>

    <div style="margin-top:auto; padding-top:28px; text-align:center;">
      <button onclick="resetData()" style="background:none; border:none; color:var(--text-dim); font-size:10px; font-weight:bold; letter-spacing:1px;">RESET ALL DATA</button>
    </div>
  </div>

  <div id="quiz-screen">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <span id="mode-tag" style="font-size:11px; font-weight:900; color:var(--text-dim);">CATEGORY FLOW</span>
      <span id="q-idx" style="font-size:12px; font-weight:900;">1 / 10</span>
    </div>
    <div id="timer-track"><div id="timer-bar"></div></div>
    
    <div style="display:flex; gap:10px; align-items:center; margin-top:6px; margin-bottom:14px;">      
  ã€€ã€€<span class="small" style="flex:1;">ğŸ“Œ ä»˜ç®‹</span>

ã€€ã€€  <button class="pill" style="border:1px solid rgba(255,255,255,0.12);" onclick="setStar('red')">èµ¤</button>
ã€€ã€€  <button class="pill" style="border:1px solid rgba(255,255,255,0.12);" onclick="setStar('blue')">é’</button>
ã€€ã€€  <button class="pill" style="border:1px solid rgba(255,255,255,0.12);" onclick="setStar('yellow')">é»„</button>
ã€€ã€€  <button class="pill" style="border:1px solid rgba(255,255,255,0.12);" onclick="clearStar()">è§£é™¤</button>
      
</div>

<div id="star-now" class="small" style="margin-top:-6px; margin-bottom:10px;"></div>

    <div id="q-box" style="flex:1; overflow-y:auto;">
      <div class="q-text" id="q-txt"></div>
      <div id="opts"></div>
      <div id="exp-box" style="display:none; margin-top:30px; background:#1e293b; padding:25px; border-radius:22px;">
        <p id="e-txt" style="font-size:15px; color:#cbd5e1; margin-bottom:10px;"></p>
        <p id="j-txt" style="font-size:13px; color:var(--accent); font-style:italic;"></p>
      </div>
    </div>
    <button id="next-btn" style="display:none; width:100%; background:white; color:black; padding:22px; border:none; border-radius:24px; font-weight:900; margin-top:20px;" onclick="nextStep()">NEXT</button>
  </div>

  <div id="history-screen">
    <div id="bookmarks-screen">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <span style="font-size:12px; font-weight:900; color:var(--text-dim); letter-spacing:1px;">BOOKMARKS</span>
    <button class="pill" onclick="closeBookmarks()">BACK</button>
  </div>

  <div style="height:14px"></div>

  <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px;">
    <button class="pill" onclick="setStarFilter('all')">å…¨éƒ¨</button>
    <button class="pill" onclick="setStarFilter('red')">èµ¤ï¼ˆè‹¦æ‰‹ï¼‰</button>
    <button class="pill" onclick="setStarFilter('blue')">é’ï¼ˆè¿·ã£ãŸï¼‰</button>
    <button class="pill" onclick="setStarFilter('yellow')">é»„ï¼ˆé‡è¦ï¼‰</button>
  </div>

  <div id="bookmarks-list" style="flex:1; overflow-y:auto;"></div>
</div>

    <div style="display:flex; justify-content:space-between; align-items:center;">
      <span style="font-size:12px; font-weight:900; color:var(--text-dim); letter-spacing:1px;">STUDY HISTORY</span>
      <button class="pill" onclick="closeHistory()">BACK</button>
    </div>
    <div style="height:18px"></div>
    <div id="history-list" style="flex:1; overflow-y:auto;"></div>
  </div>

  <script>
    /**********************
     * NextStage v1.3
     * - ã‚«ãƒ†ã‚´ãƒªé †ã«å‡ºé¡Œã—ã€10å•æœªæº€ã¯æ¬¡ã‚«ãƒ†ã‚´ãƒªã§è£œå……
     * - æœªå®šç€ã§ã‚‚æ¬¡ã‚«ãƒ†ã‚´ãƒªã¸é€²ã‚€ï¼ˆå›ºå®šã—ãªã„ï¼‰
     * - åŒã˜æ—¥ã«è§£ã„ãŸå•é¡Œã¯ãã®æ—¥ã¯å‡ºã•ãªã„
     **********************/

    const INITIAL = [];


    // Pointç•ªå·é †ï¼ˆç©ºã§è‡ªå‹•ï¼‰
    const CATEGORY_ORDER = [];
    const SR_INTERVAL_DAYS = [0, 1, 3, 7, 14, 30]; // å¿˜å´æ›²ç·šï¼ˆæ­£è§£æ™‚ã«æ¬¡å›è¡¨ç¤ºã‚’é…ã‚‰ã›ã‚‹ï¼‰

    // ===== Question JSON loader =====
const QUESTION_FILES = [
  "questions/point008.json",
  "questions/point009.json",
  "questions/point010.json",
  "questions/point011.json"
];

let loadedQuestions = [];

async function loadAllQuestions() {
  let all = [];
  for (const f of QUESTION_FILES) {
    const res = await fetch(f, { cache: "no-store" });
    if (!res.ok) throw new Error("Failed to load " + f);
    const data = await res.json();
    all = all.concat(data);
  }
  return all;
}

    let state = JSON.parse(localStorage.getItem('gd_v4_pro')) || {
      xp: 0,
      last: 0,
      mastery: {},
      custom: [],
      history: [],
      currCat: null
      stars: {}
    };

    state.history = state.history || [];
    state.custom = state.custom || [];
    state.mastery = state.mastery || {};
    state.currCat = state.currCat || null;
    state.stars = state.stars || {};

    let currentQ = [];
    let curIdx = 0;
    let timer = null;
    let timeLeft = 100;
    let isAnswered = false;

    let session = null;
    let sessionMode = "CATEGORY FLOW";

    window.onload = async () => {
  try {
    loadedQuestions = await loadAllQuestions();
    render();
  } catch (e) {
    alert("å•é¡Œãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n" + e.message);
    render();
  }
};


    function allQuestions() {
  return [...loadedQuestions, ...state.custom];
}


    function getM(qid) {
      const m = state.mastery[qid];
      if (!m) return { level: 0, lastSeen: 0, nextDue: 0 };
      if (typeof m === 'number') return { level: m, lastSeen: 0, nextDue: 0 };
      return {
        level: Number(m.level || 0),
        lastSeen: Number(m.lastSeen || 0),
        nextDue: Number(m.nextDue || 0)
      };
    }
    function setM(qid, obj) {
      state.mastery[qid] = {
        level: Number(obj.level || 0),
        lastSeen: Number(obj.lastSeen || 0),
        nextDue: Number(obj.nextDue || 0)
      };
    }

    function autoCategoryOrder(all) {
      const uniq = [];
      const seen = new Set();
      for (const q of all) {
        if (!seen.has(q.cat)) { seen.add(q.cat); uniq.push(q.cat); }
      }
      const withNum = [];
      const withoutNum = [];
      for (const c of uniq) {
        const m = String(c).match(/Point\s*0*([0-9]+)/i);
        if (m) withNum.push({ c, n: Number(m[1]) });
        else withoutNum.push(c);
      }
      withNum.sort((a,b)=>a.n-b.n);
      return [...withNum.map(x=>x.c), ...withoutNum];
    }

    function getCategoryOrder(all) {
      if (Array.isArray(CATEGORY_ORDER) && CATEGORY_ORDER.length > 0) return CATEGORY_ORDER;
      return autoCategoryOrder(all);
    }

    function getCurrentCategory(all) {
      const order = getCategoryOrder(all);
      if (!state.currCat || !order.includes(state.currCat)) {
        state.currCat = order[0] || null;
      }
      return state.currCat;
    }

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function startOfToday() {
      const d = new Date();
      d.setHours(0, 0, 0, 0);
      return d.getTime();
    }
    function seenToday(qid) {
      const m = getM(qid);
      return (m.lastSeen || 0) >= startOfToday();
    }

    function render() {
      const lv = Math.floor(state.xp / 1000) + 1;
      const xp = state.xp % 1000;
      document.getElementById('lv-text').innerText = `LEVEL ${lv}`;
      document.getElementById('xp-val').innerText = `${xp} / 1000 XP`;
      document.getElementById('xp-bar').style.width = (xp / 10) + '%';

      const all = allQuestions();
      const cur = getCurrentCategory(all);

      const cats = {};
      all.forEach(q => {
        if (!cats[q.cat]) cats[q.cat] = { count: 0, sumLevel: 0 };
        cats[q.cat].count++;
        cats[q.cat].sumLevel += (getM(q.id).level || 0);
      });

      const sorted = Object.keys(cats).map(n => ({
        name: n,
        prog: Math.floor((cats[n].sumLevel / cats[n].count) * 20)
      })).sort((a,b) => a.prog - b.prog);

      const list = document.getElementById('cat-list');
      list.innerHTML = '';
      sorted.forEach(c => {
        const div = document.createElement('div');
        div.className = 'cat-card';
        const isCur = (cur && c.name === cur);
        div.innerHTML =
          `<div>
            <div class="cat-name">${escapeHtml(c.name)} ${isCur ? `<span class="tag-current">CURRENT</span>` : ``}</div>
            <div class="cat-meta">${c.prog}% MASTERED</div>
          </div>
          <div style="font-size:10px; font-weight:900; color:var(--text-dim);">
            ${c.prog < 40 ? 'âš ï¸ LOW' : (c.prog >= 80 ? 'âœ¨ STRONG' : 'OK')}
          </div>`;
        list.appendChild(div);
      });

      localStorage.setItem('gd_v4_pro', JSON.stringify(state));
    }

    /********** v1.3 å‡ºé¡Œï¼ˆã‚«ãƒ†ã‚´ãƒªè£œå…… + æ—¥å†…é‡è¤‡ãªã— + æ¯å›ã‚«ãƒ†ã‚´ãƒªé€²è¡Œï¼‰ **********/
    function startSession() {
      const all = allQuestions();
      const order = getCategoryOrder(all);
      if (!order.length) return;

      const cur = getCurrentCategory(all);
      let startIdx = order.indexOf(cur);
      if (startIdx < 0) startIdx = 0;

      const picked = [];
      const pickedIds = new Set();

      function addQ(q) {
        if (picked.length >= 10) return;
        if (pickedIds.has(q.id)) return;
        if (seenToday(q.id)) return; // â˜…åŒæ—¥é‡è¤‡ãªã—
        picked.push(q);
        pickedIds.add(q.id);
      }

      // â‘  æœŸé™å¾©ç¿’ï¼ˆä»Šæ—¥è§£ã„ãŸã‚‚ã®ã¯é™¤å¤–ï¼‰
      const now = Date.now();
      const due = all
        .filter(q => (getM(q.id).nextDue || 0) <= now)
        .sort((a,b) => (getM(a.id).nextDue - getM(b.id).nextDue) || (getM(a.id).level - getM(b.id).level));
      shuffle(due.slice()).forEach(addQ);

      // â‘¡ ã‚«ãƒ†ã‚´ãƒªé †ã§è£œå……ï¼šcur â†’ æ¬¡ â†’ æ¬¡...
      for (let k = 0; k < order.length && picked.length < 10; k++) {
        const cat = order[(startIdx + k) % order.length];
        const catQs = all
          .filter(q => q.cat === cat)
          .sort((a,b) => (getM(a.id).level - getM(b.id).level) || ((getM(a.id).nextDue||0) - (getM(b.id).nextDue||0)));
        shuffle(catQs.slice()).forEach(addQ);
      }

      // â‘¢ ãã‚Œã§ã‚‚ä¸è¶³ãªã‚‰ï¼šå…¨ä½“ã‹ã‚‰è£œå……ï¼ˆä»Šæ—¥è§£ã„ã¦ãªã„ï¼‰
      if (picked.length < 10) {
        const weak = all.slice().sort((a,b) => getM(a.id).level - getM(b.id).level);
        shuffle(weak.slice()).forEach(addQ);
      }

      currentQ = picked; // 10æœªæº€ãªã‚‰ãã®ã¾ã¾
      curIdx = 0;

      // â˜…æœªå®šç€ã§ã‚‚æ¬¡ã‚«ãƒ†ã‚´ãƒªã¸é€²ã‚€ï¼ˆæ¯å›1ã¤é€²ã‚ã‚‹ï¼‰
      state.currCat = order[(startIdx + 1) % order.length];

      sessionMode = `CAT FLOW: ${cur} â†’ ${state.currCat}`;
      document.getElementById('mode-tag').innerText = sessionMode;

      session = {
        startedAt: Date.now(),
        totalPlanned: currentQ.length,
        answered: 0,
        correct: 0,
        wrong: []
      };

      localStorage.setItem('gd_v4_pro', JSON.stringify(state));

      document.getElementById('home').style.display = 'none';
      document.getElementById('quiz-screen').style.display = 'flex';
      loadQ();
    }

    function loadQ() {
      const q = currentQ[curIdx];
      activeQ = q;
ã€€ã€€ã€€document.getElementById('mode-tag').innerText = `${q.cat} ${q.id}`;
ã€€ã€€ã€€renderStarNow();
      isAnswered = false;
      document.getElementById('q-idx').innerText = `${curIdx + 1} / ${currentQ.length}`;
      document.getElementById('q-txt').innerText = q.q;
      document.getElementById('exp-box').style.display = 'none';
      document.getElementById('next-btn').style.display = 'none';

      const optCont = document.getElementById('opts');
      optCont.innerHTML = '';
      q.opts.forEach((o, i) => {
        const b = document.createElement('button');
        b.className = 'option';
        b.innerText = o;
        b.onclick = () => handleAns(i);
        optCont.appendChild(b);
      });

      startTimer();
    }

    function startTimer() {
      clearInterval(timer);
      timeLeft = 100;
      timer = setInterval(() => {
        timeLeft -= 1.0;
        document.getElementById('timer-bar').style.width = timeLeft + '%';
        if (timeLeft <= 0) handleAns(-1);
      }, 100);
    }

    function handleAns(idx) {
      if (isAnswered) return;
      isAnswered = true;
      clearInterval(timer);

      const q = currentQ[curIdx];
      const ok = idx === q.ans;

      session.answered += 1;
      if (ok) session.correct += 1;
      else session.wrong.push({ id: q.id, selected: idx, correct: q.ans });

      const m = getM(q.id);
      m.lastSeen = Date.now();

      if (ok) {
        const pop = document.getElementById('success-msg');
        pop.style.display = 'flex';
        setTimeout(() => pop.style.display = 'none', 2000);

        state.xp += 50;

        const nextLevel = Math.min(m.level + 1, 5);
        m.level = nextLevel;
        const days = SR_INTERVAL_DAYS[nextLevel] || 1;
        m.nextDue = Date.now() + days * 24 * 60 * 60 * 1000;
      } else {
        m.level = Math.max(0, m.level - 1);
        m.nextDue = Date.now(); // ã™ãå¾©ç¿’å¯¾è±¡
      }
      setM(q.id, m);

      const btns = document.getElementById('opts').children;
      for (let i = 0; i < btns.length; i++) {
        if (i === q.ans) btns[i].classList.add('correct');
        else if (i === idx) btns[i].classList.add('wrong');
        btns[i].disabled = true;
      }

      document.getElementById('e-txt').innerText = q.exp;
      document.getElementById('j-txt').innerText = "å’Œè¨³: " + q.jp;
      document.getElementById('exp-box').style.display = 'block';
      document.getElementById('next-btn').style.display = 'block';

      state.last = Date.now();
      localStorage.setItem('gd_v4_pro', JSON.stringify(state));
    }

    function finishSession() {
      const total = session.answered;
      const correct = session.correct;
      const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;

      state.history.unshift({
        at: Date.now(),
        total,
        correct,
        accuracy,
        wrong: session.wrong
      });

      localStorage.setItem('gd_v4_pro', JSON.stringify(state));
      session = null;

      document.getElementById('quiz-screen').style.display = 'none';
      document.getElementById('home').style.display = 'flex';
      render();
    }

    function nextStep() {
      if (curIdx < currentQ.length - 1) { curIdx++; loadQ(); }
      else { finishSession(); }
    }

    function openHistory() {
      document.getElementById('home').style.display = 'none';
      document.getElementById('history-screen').style.display = 'flex';
      renderHistory();
    }

    function closeHistory() {
      document.getElementById('history-screen').style.display = 'none';
      document.getElementById('home').style.display = 'flex';
      render();
    }

    function renderHistory() {
      const list = document.getElementById('history-list');
      list.innerHTML = '';

      if (!state.history || state.history.length === 0) {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `<div style="font-weight:900;">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>
                         <div class="small" style="margin-top:8px;">STARTã—ã¦è§£ãã¨ã€ã“ã“ã«è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚</div>`;
        list.appendChild(div);
        return;
      }

      const qMap = new Map(allQuestions().map(q => [q.id, q]));

      state.history.forEach(h => {
        const d = new Date(h.at);
        const dateStr = `${d.getFullYear()}/${pad2(d.getMonth()+1)}/${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
        const card = document.createElement('div');
        card.className = 'card';

        card.innerHTML = `
          <div class="row">
            <div style="font-weight:900;">${dateStr}</div>
            <div class="pill">${h.total}å•</div>
          </div>
          <div class="row" style="margin-top:10px;">
            <div class="small">æ­£è§£: <span class="success">${h.correct}</span> / ${h.total}</div>
            <div class="small">æ­£è§£ç‡: <span class="success">${h.accuracy}%</span></div>
          </div>
          <div style="height:10px"></div>
          <div class="small">èª¤ç­”ä¸€è¦§</div>
        `;

        const wrongWrap = document.createElement('div');
        wrongWrap.style.marginTop = '10px';

        if (!h.wrong || h.wrong.length === 0) {
          const w = document.createElement('div');
          w.className = 'small';
          w.style.color = 'var(--success)';
          w.textContent = 'å…¨å•æ­£è§£ ğŸ‰';
          wrongWrap.appendChild(w);
        } else {
          h.wrong.forEach(wi => {
            const q = qMap.get(wi.id);
            const qText = q ? q.q : '(å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼šå¤‰æ›´/å‰Šé™¤ã•ã‚ŒãŸå¯èƒ½æ€§)';
            const correctOpt = q ? q.opts[wi.correct] : '(ä¸æ˜)';
            const selectedOpt =
              wi.selected === -1 ? 'ï¼ˆæ™‚é–“åˆ‡ã‚Œï¼‰' : (q ? q.opts[wi.selected] : '(ä¸æ˜)');

            const item = document.createElement('div');
            item.className = 'card';
            item.style.background = '#111827';
            item.style.border = '1px solid rgba(255,255,255,0.06)';
            item.style.marginTop = '10px';
            item.innerHTML = `
              <div style="font-weight:900; line-height:1.4;">${escapeHtml(qText)}</div>
              <div style="height:10px"></div>
              <div class="small">ã‚ãªãŸ: <span class="danger">${escapeHtml(selectedOpt)}</span></div>
              <div class="small">æ­£è§£: <span class="success">${escapeHtml(correctOpt)}</span></div>
              ${q && q.jp ? `<div class="small" style="margin-top:10px; color:#93c5fd;">å’Œè¨³: ${escapeHtml(q.jp)}</div>` : ``}
            `;
            wrongWrap.appendChild(item);
          });
        }

        card.appendChild(wrongWrap);
        list.appendChild(card);
      });
    }

    function handleScan(input) {
      if (input.files.length === 0) return;
      document.getElementById('loading-overlay').style.display = 'flex';
      document.getElementById('loading-sub').innerText = `${input.files.length}æšã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æä¸­...`;

      setTimeout(() => {
        for (let i = 0; i < input.files.length; i++) {
          const newQ = {
            id: Date.now() + i,
            cat: "Point 010 (ADDED)",
            q: "Added from scan " + (i + 1) + " ( )?",
            opts: ["Correct", "Wrong", "Wrong", "Wrong"],
            ans: 0,
            exp: "ï¼ˆç¾çŠ¶ã¯ãƒ‡ãƒ¢ã§ã™ï¼‰æ‰‹å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ç‰ˆã«ã™ã‚‹ã¨ã€è§£èª¬ã‚’ã—ã£ã‹ã‚Šå…¥ã‚Œã‚‰ã‚Œã¾ã™ã€‚",
            jp: "ï¼ˆç¾çŠ¶ã¯ãƒ‡ãƒ¢ã§ã™ï¼‰"
          };
          state.custom.push(newQ);
        }
        localStorage.setItem('gd_v4_pro', JSON.stringify(state));
        document.getElementById('loading-overlay').style.display = 'none';
        render();
        input.value = '';
      }, 1500);
    }

    function exportData() {
      const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      const d = new Date();
      a.download = `nextstage_backup_${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function importData(input) {
      const file = input.files?.[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        try {
          const obj = JSON.parse(reader.result);
          if (!obj || typeof obj !== 'object') throw new Error('invalid');

          obj.xp = Number(obj.xp || 0);
          obj.last = Number(obj.last || 0);
          obj.mastery = obj.mastery || {};
          obj.custom = obj.custom || [];
          obj.history = obj.history || [];
          obj.currCat = obj.currCat || null;

          state = obj;
          localStorage.setItem('gd_v4_pro', JSON.stringify(state));
          alert('å¾©å…ƒã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚');
          location.reload();
        } catch (e) {
          alert('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚BACKUPã—ãŸJSONã‚’é¸ã‚“ã§ãã ã•ã„ã€‚');
        }
      };
      reader.readAsText(file);
      input.value = '';
    }

    function resetData() {
      if (confirm("ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) {
        localStorage.clear();
        location.reload();
      }
    }

    function pad2(n) { return String(n).padStart(2, '0'); }
    let activeQ = null;           // ä»Šè¡¨ç¤ºã—ã¦ã„ã‚‹å•é¡Œ
let starFilter = "all";       // bookmarksç”»é¢ãƒ•ã‚£ãƒ«ã‚¿

function ensureStars() {
  state.stars = state.stars || {};
}

function getStar(qid) {
  ensureStars();
  return state.stars[String(qid)] || null;
}

function setStar(color) {
  if (!activeQ) return;
  ensureStars();
  state.stars[String(activeQ.id)] = color;
  localStorage.setItem('gd_v4_pro', JSON.stringify(state));
  renderStarNow();
}

function clearStar() {
  if (!activeQ) return;
  ensureStars();
  delete state.stars[String(activeQ.id)];
  localStorage.setItem('gd_v4_pro', JSON.stringify(state));
  renderStarNow();
}

function starLabel(c) {
  if (c === "red") return "èµ¤ï¼ˆè‹¦æ‰‹ï¼‰";
  if (c === "blue") return "é’ï¼ˆè¿·ã£ãŸï¼‰";
  if (c === "yellow") return "é»„ï¼ˆé‡è¦ï¼‰";
  return "ãªã—";
}

function renderStarNow() {
  const el = document.getElementById("star-now");
  if (!el) return;
  if (!activeQ) { el.textContent = ""; return; }
  const s = getStar(activeQ.id);
  el.textContent = s ? `ã“ã®å•é¡Œã®ä»˜ç®‹ï¼š${starLabel(s)}` : "ã“ã®å•é¡Œã®ä»˜ç®‹ï¼šãªã—";
}

/********** BOOKMARKSç”»é¢ **********/
function openBookmarks() {
  document.getElementById('home').style.display = 'none';
  document.getElementById('history-screen').style.display = 'none';
  document.getElementById('bookmarks-screen').style.display = 'flex';
  renderBookmarks();
}

function closeBookmarks() {
  document.getElementById('bookmarks-screen').style.display = 'none';
  document.getElementById('home').style.display = 'flex';
  render();
}

function setStarFilter(f) {
  starFilter = f;
  renderBookmarks();
}

function renderBookmarks() {
  ensureStars();
  const list = document.getElementById('bookmarks-list');
  list.innerHTML = '';

  const all = allQuestions();
  const qMap = new Map(all.map(q => [String(q.id), q]));
  const entries = Object.entries(state.stars); // [id, color]

  const filtered = entries
    .filter(([id, color]) => starFilter === "all" ? true : color === starFilter)
    .map(([id, color]) => ({ id, color, q: qMap.get(id) }))
    .filter(x => !!x.q); // å•é¡ŒãŒå­˜åœ¨ã™ã‚‹ã‚‚ã®ã ã‘

  if (filtered.length === 0) {
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `<div style="font-weight:900;">ä»˜ç®‹ãŒã‚ã‚Šã¾ã›ã‚“</div>
                     <div class="small" style="margin-top:8px;">å•é¡Œç”»é¢ã§ã€Œèµ¤/é’/é»„ã€ã‚’æŠ¼ã™ã¨ã€ã“ã“ã«é›†ã¾ã‚Šã¾ã™ã€‚</div>`;
    list.appendChild(div);
    return;
  }

  // è¡¨ç¤ºï¼šPointç•ªå·é †â†’å•é¡Œç•ªå·é †
  filtered.sort((a,b) => {
    const ac = a.q.cat || "";
    const bc = b.q.cat || "";
    if (ac !== bc) return ac.localeCompare(bc, "ja");
    return Number(a.q.id) - Number(b.q.id);
  });

  filtered.forEach(x => {
    const q = x.q;
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="row">
        <div style="font-weight:900;">${escapeHtml(q.cat)} / ${escapeHtml(q.id)}</div>
        <div class="pill">ğŸ“Œ ${escapeHtml(starLabel(x.color))}</div>
      </div>
      <div style="height:10px"></div>
      <div style="line-height:1.5;">${escapeHtml(q.q)}</div>
      ${q.jp ? `<div class="small" style="margin-top:10px; color:#93c5fd;">å’Œè¨³: ${escapeHtml(q.jp)}</div>` : ``}
      <div style="height:10px"></div>
      <button class="pill" onclick="removeBookmark('${escapeHtml(String(q.id))}')">ã“ã®ä»˜ç®‹ã‚’å¤–ã™</button>
    `;
    list.appendChild(card);
  });
}

function removeBookmark(qidStr) {
  ensureStars();
  delete state.stars[String(qidStr)];
  localStorage.setItem('gd_v4_pro', JSON.stringify(state));
  renderBookmarks();
}

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
  </script>
</body>
</html>


