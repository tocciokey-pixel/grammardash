<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>GrammarDash Pro</title>
    <style>
        :root {
            --bg: #0a0f1e;
            --card: #161e31;
            --accent: #22d3ee;
            --danger: #f43f5e;
            --success: #10b981;
            --text: #ffffff;
            --text-dim: #64748b;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Hiragino Kaku Gothic ProN", sans-serif;
            overflow-x: hidden;
            -webkit-user-select: none;
        }
        .container { max-width: 500px; margin: 0 auto; min-height: 100vh; padding: 20px; display: flex; flex-direction: column; padding-bottom: 50px; }
        
        header { padding: 40px 0 20px; }
        h1 { font-size: 32px; font-weight: 900; font-style: italic; background: linear-gradient(90deg, #22d3ee, #818cf8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -1px; }
        
        .xp-container { background: #1e293b; height: 10px; border-radius: 5px; margin-top: 15px; overflow: hidden; }
        .xp-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .stats-text { display: flex; justify-content: space-between; font-size: 11px; font-weight: 900; color: var(--text-dim); margin-top: 6px; letter-spacing: 1px; }

        .btn-start {
            background: linear-gradient(135deg, #22d3ee, #3b82f6);
            border: none; border-radius: 28px; padding: 28px; color: #0a0f1e;
            font-size: 20px; font-weight: 900; width: 100%; margin: 25px 0;
            box-shadow: 0 12px 30px rgba(34, 211, 238, 0.3); transition: transform 0.1s;
        }
        .btn-start:active { transform: scale(0.96); }

        .btn-secondary {
            background: var(--card); border: 1px solid #2d3748; padding: 18px;
            border-radius: 20px; color: white; font-weight: bold; font-size: 14px;
            width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 30px;
        }

        .section-title { font-size: 11px; font-weight: 900; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 15px; }
        .cat-card {
            background: var(--card); border-radius: 22px; padding: 20px; margin-bottom: 12px;
            display: flex; align-items: center; justify-content: space-between;
            border: 1px solid rgba(255,255,255,0.03);
        }
        .cat-name { font-size: 16px; font-weight: 800; margin-bottom: 4px; }
        .cat-meta { font-size: 11px; font-weight: bold; color: var(--accent); display: flex; align-items: center; gap: 6px; }

        #quiz-screen {
            position: fixed; inset: 0; background: var(--bg); z-index: 1000;
            display: none; flex-direction: column; padding: 20px; padding-top: 60px;
        }
        #timer-track { width: 100%; height: 6px; background: #1e293b; border-radius: 3px; margin: 20px 0; overflow: hidden; }
        #timer-bar { height: 100%; background: var(--accent); width: 100%; transition: width 0.1s linear; }
        
        .q-text { font-size: 24px; font-weight: 800; line-height: 1.4; margin-bottom: 40px; }
        .option {
            background: var(--card); border: 2px solid #2d3748; padding: 20px;
            border-radius: 18px; color: white; text-align: left; font-size: 17px; font-weight: 600;
            margin-bottom: 12px; width: 100%;
        }
        .option.correct { border-color: var(--success); background: rgba(16,185,129,0.15); color: var(--success); }
        .option.wrong { border-color: var(--danger); background: rgba(244,63,89,0.15); color: var(--danger); }

        #success-msg {
            position: fixed; inset: 0; z-index: 2000; display: none;
            align-items: center; justify-content: center; background: rgba(10,15,30,0.7);
        }
        .pop {
            background: var(--accent); color: #0a0f1e; padding: 40px; border-radius: 50%;
            width: 200px; height: 200px; display: flex; flex-direction: column; align-items: center;
            justify-content: center; font-weight: 900; font-size: 26px;
            animation: slowPop 2.0s ease-in-out forwards;
        }
        @keyframes slowPop {
            0% { transform: scale(0.2); opacity: 0; }
            15% { transform: scale(1.1); opacity: 1; }
            85% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.2); opacity: 0; }
        }

        #loading-overlay {
            position: fixed; inset: 0; background: rgba(10,15,30,0.95); z-index: 5000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 20px;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--accent); border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        #reminder {
            position: fixed; top: 20px; left: 20px; right: 20px; background: #fbbf24;
            color: #78350f; padding: 20px; border-radius: 20px; z-index: 4000;
            display: none; font-weight: 900; box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        }
    </style>
</head>
<body>

    <div id="reminder" onclick="this.style.display='none'">
        ‚è∞ 19:30„ÇíÈÅé„Åé„Åæ„Åó„ÅüÔºÅ<br>‰ªäÊó•„ÅÆÂæ©Áøí„Çø„Ç§„É†„Åß„Åô„ÄÇ
    </div>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div style="font-weight:900;">AI ANALYZING...</div>
        <div id="loading-sub" style="font-size:11px; color:var(--text-dim); margin-top:10px;">Ë§áÊï∞Êûö„ÅÆ„Éï„Ç°„Ç§„É´„Åã„ÇâÂïèÈ°å„ÇíÁîüÊàê‰∏≠</div>
    </div>

    <div id="success-msg"><div class="pop">EXCELLENT!</div></div>

    <div class="container" id="home">
        <header>
            <h1>GrammarDash</h1>
            <div class="xp-container"><div id="xp-bar" class="xp-fill"></div></div>
            <div class="stats-text">
                <span id="lv-text">LEVEL 1</span>
                <span id="xp-val">0 / 1000 XP</span>
            </div>
        </header>

        <button class="btn-start" onclick="startSession()">
            START 10 QUESTIONS
        </button>

        <button class="btn-secondary" onclick="document.getElementById('input').click()">
            <span>üì∏ ADD PHOTOS / PDF</span>
            <input type="file" id="input" multiple accept="image/*,application/pdf" style="display:none" onchange="handleScan(this)">
        </button>

        <div class="section-title">Weakness Areas</div>
        <div id="cat-list"></div>
        
        <div style="margin-top:auto; padding-top:40px; text-align:center;">
            <button onclick="resetData()" style="background:none; border:none; color:var(--text-dim); font-size:10px; font-weight:bold; letter-spacing:1px;">RESET ALL DATA</button>
        </div>
    </div>

    <div id="quiz-screen">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <span style="font-size:11px; font-weight:900; color:var(--text-dim);">MIXED REVIEW</span>
            <span id="q-idx" style="font-size:12px; font-weight:900;">1 / 10</span>
        </div>
        <div id="timer-track"><div id="timer-bar"></div></div>
        <div id="q-box" style="flex:1; overflow-y:auto;">
            <div class="q-text" id="q-txt"></div>
            <div id="opts"></div>
            <div id="exp-box" style="display:none; margin-top:30px; background:#1e293b; padding:25px; border-radius:22px;">
                <p id="e-txt" style="font-size:15px; color:#cbd5e1; margin-bottom:10px;"></p>
                <p id="j-txt" style="font-size:13px; color:var(--accent); font-style:italic;"></p>
            </div>
        </div>
        <button id="next-btn" style="display:none; width:100%; background:white; color:black; padding:22px; border:none; border-radius:24px; font-weight:900; margin-top:20px;" onclick="nextStep()">NEXT</button>
    </div>

    <script>
        const INITIAL = [
            { id: 1, cat: "Point 008", q: "I'll be at home watching TV until ( ).", opts: ["you come back", "you be back", "you will be back", "you will have been back"], ans: 0, exp: "untilÁØÄÔºàÊôÇ„ÅÆÂâØË©ûÁØÄÔºâ„ÅÆ‰∏≠„Åß„ÅØÁèæÂú®ÊôÇÂà∂„ÇíÁî®„ÅÑ„Åæ„Åô„ÄÇ", jp: "„ÅÇ„Å™„Åü„ÅåÊàª„Å£„Å¶„Åè„Çã„Åæ„ÅßÂÆ∂„Å´„ÅÑ„Åæ„Åô„ÄÇ" },
            { id: 2, cat: "Point 009", q: "I don't know when he ( ) in the office.", opts: ["will be back", "is back", "is being back", "be back"], ans: 0, exp: "„Äå„ÅÑ„Å§„Äú„Åô„Çã„Åã„Äç„Å®„ÅÑ„ÅÜÂêçË©ûÁØÄ„Å™„ÅÆ„Åßwill„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ", jp: "„ÅÑ„Å§Êàª„Çã„ÅãÂàÜ„Åã„Çä„Åæ„Åõ„Çì„ÄÇ" }
        ];

        // „Éá„Éº„Çø„ÅÆÂºï„ÅçÁ∂ô„Åé: „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Çí‰ΩøÁî®
        let state = JSON.parse(localStorage.getItem('gd_v4_pro')) || {
            xp: 0, last: 0, mastery: {}, custom: []
        };

        let currentQ = [];
        let curIdx = 0;
        let timer = null;
        let timeLeft = 100;
        let isAnswered = false;

        window.onload = () => {
            checkRemind();
            render();
        };

        function checkRemind() {
            const now = new Date();
            const last = new Date(state.last);
            if (now.getHours() >= 19 && now.getMinutes() >= 30 && last.getDate() !== now.getDate()) {
                document.getElementById('reminder').style.display = 'block';
            }
        }

        function render() {
            const lv = Math.floor(state.xp / 1000) + 1;
            const xp = state.xp % 1000;
            document.getElementById('lv-text').innerText = `LEVEL ${lv}`;
            document.getElementById('xp-val').innerText = `${xp} / 1000 XP`;
            document.getElementById('xp-bar').style.width = (xp / 10) + '%';

            const all = [...INITIAL, ...state.custom];
            const cats = {};
            all.forEach(q => {
                if (!cats[q.cat]) cats[q.cat] = { count: 0, score: 0 };
                cats[q.cat].count++;
                cats[q.cat].score += (state.mastery[q.id]?.level || 0) * 20;
            });

            // ÁêÜËß£Â∫¶„Åå‰Ωé„ÅÑÈ†Ü„Å´‰∏¶„Å≥Êõø„Åà
            const sorted = Object.keys(cats).map(n => ({
                name: n,
                prog: Math.floor(cats[n].score / cats[n].count)
            })).sort((a,b) => a.prog - b.prog);

            const list = document.getElementById('cat-list');
            list.innerHTML = '';
            sorted.forEach(c => {
                const div = document.createElement('div');
                div.className = 'cat-card';
                div.innerHTML = `<div><div class="cat-name">${c.name}</div><div class="cat-meta">${c.prog}% MASTERED</div></div><div style="font-size:10px; font-weight:900; color:var(--text-dim);">${c.prog < 40 ? '‚ö†Ô∏è LOW' : 'OK'}</div>`;
                list.appendChild(div);
            });
        }

        function startSession() {
            const all = [...INITIAL, ...state.custom];
            // ÂÖ®ÂïèÈ°å„ÇíÊ∑∑„Åú„Å¶„ÄÅÁêÜËß£Â∫¶„Åå‰Ωé„ÅÑ„ÇÇ„ÅÆ„ÇíÂÑ™ÂÖàÁöÑ„Å´10ÂïèÊäΩÂá∫
            currentQ = all.sort((a,b) => (state.mastery[a.id]?.level || 0) - (state.mastery[b.id]?.level || 0))
                          .slice(0, 10).sort(()=>Math.random()-0.5);
            curIdx = 0;
            document.getElementById('home').style.display = 'none';
            document.getElementById('quiz-screen').style.display = 'flex';
            loadQ();
        }

        function loadQ() {
            const q = currentQ[curIdx];
            isAnswered = false;
            document.getElementById('q-idx').innerText = `${curIdx + 1} / ${currentQ.length}`;
            document.getElementById('q-txt').innerText = q.q;
            document.getElementById('exp-box').style.display = 'none';
            document.getElementById('next-btn').style.display = 'none';
            const optCont = document.getElementById('opts');
            optCont.innerHTML = '';
            q.opts.forEach((o, i) => {
                const b = document.createElement('button');
                b.className = 'option';
                b.innerText = o;
                b.onclick = () => handleAns(i);
                optCont.appendChild(b);
            });
            startTimer();
        }

        function startTimer() {
            clearInterval(timer);
            timeLeft = 100;
            timer = setInterval(() => {
                timeLeft -= 1.0; 
                document.getElementById('timer-bar').style.width = timeLeft + '%';
                if (timeLeft <= 0) handleAns(-1);
            }, 100); // 10Áßí
        }

        function handleAns(idx) {
            if (isAnswered) return;
            isAnswered = true;
            clearInterval(timer);
            const q = currentQ[curIdx];
            const ok = idx === q.ans;
            
            if (ok) {
                const pop = document.getElementById('success-msg');
                pop.style.display = 'flex';
                setTimeout(() => pop.style.display = 'none', 2000); // „ÇÜ„Å£„Åè„ÇäË°®Á§∫
                state.xp += 50;
                if (!state.mastery[q.id]) state.mastery[q.id] = { level: 0 };
                state.mastery[q.id].level = Math.min(state.mastery[q.id].level + 1, 5);
            } else {
                if (!state.mastery[q.id]) state.mastery[q.id] = { level: 0 };
                state.mastery[q.id].level = Math.max(0, state.mastery[q.id].level - 1);
            }

            const btns = document.getElementById('opts').children;
            for(let i=0; i<btns.length; i++) {
                if (i === q.ans) btns[i].classList.add('correct');
                else if (i === idx) btns[i].classList.add('wrong');
                btns[i].disabled = true;
            }
            document.getElementById('e-txt').innerText = q.exp;
            document.getElementById('j-txt').innerText = "ÂíåË®≥: " + q.jp;
            document.getElementById('exp-box').style.display = 'block';
            document.getElementById('next-btn').style.display = 'block';
            state.last = Date.now();
            localStorage.setItem('gd_v4_pro', JSON.stringify(state));
        }

        function nextStep() {
            if (curIdx < currentQ.length - 1) { curIdx++; loadQ(); }
            else { document.getElementById('quiz-screen').style.display='none'; document.getElementById('home').style.display='flex'; render(); }
        }

        function handleScan(input) {
            if (input.files.length === 0) return;
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-sub').innerText = `${input.files.length}Êûö„ÅÆ„Éï„Ç°„Ç§„É´„ÇíËß£Êûê‰∏≠...`;
            
            // Ë§áÊï∞ÂÜôÁúü„ÉªPDFÂØæÂøú„ÅÆAIÊì¨‰ººÂá¶ÁêÜ
            setTimeout(() => {
                for(let i=0; i < input.files.length; i++){
                    const newQ = { 
                        id: Date.now() + i, 
                        cat: "Point 010 (AI)", 
                        q: "Added from scan " + (i+1) + " ( )?", 
                        opts: ["Correct", "Wrong", "Wrong", "Wrong"], 
                        ans: 0, 
                        exp: "Ë§áÊï∞„Éï„Ç°„Ç§„É´„Åã„Çâ„ÅÆÁµêÂêàËß£ÊûêÁµêÊûú„Åß„Åô„ÄÇ", 
                        jp: "ÂíåË®≥„Åß„Åô„ÄÇ" 
                    };
                    state.custom.push(newQ);
                }
                localStorage.setItem('gd_v4_pro', JSON.stringify(state));
                document.getElementById('loading-overlay').style.display = 'none';
                render();
            }, 2500);
        }

        function resetData() { if(confirm("„Éá„Éº„Çø„ÇíÂÖ®„Å¶Ê∂àÂéª„Åó„Åæ„Åô„ÅãÔºü")){ localStorage.clear(); location.reload(); } }
    </script>
</body>
</html>